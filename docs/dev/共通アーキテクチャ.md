# AIDraft 共通アーキテクチャ（V2.1統合版）

## 全体システム構成

```
AIDraft システム群（V2.1統合版）
├── sheets/プロジェクト      [3シート統合処理]
│   ├── WeekenDentシート    [Googleフォーム → スプレッドシート → AI → Gmail]
│   ├── その他セミナーシート [Googleフォーム → スプレッドシート → AI → Gmail]
│   ├── お問い合わせシート   [Googleフォーム → スプレッドシート → AI → Gmail]
│   └── AI処理管理シート    [処理状況一元管理]
└── gmail/プロジェクト       [Gmail受信 → AI → Gmail返信]
```

## 共通技術スタック

### プラットフォーム
- **実行環境**: Google Apps Script (GAS)
- **言語**: JavaScript (ES6+)
- **デプロイ**: Google Clasp
- **バージョン管理**: Git

### 外部API
- **AI**: OpenAI GPT-4o-mini
- **メール**: Gmail API
- **スプレッドシート**: Google Sheets API

### 認証・権限
- **Gmail**: OAuth 2.0
- **Sheets**: OAuth 2.0  
- **OpenAI**: API Key認証

## 共通ファイル構成

### 標準ディレクトリ構造（V2.1統合版）
```
[プロジェクト名]/
├── README.md               # プロジェクト固有ドキュメント
├── .clasp.json            # GASデプロイ設定
└── src/
    ├── appsscript.json    # GAS設定ファイル
    ├── config/
    │   ├── common.js      # 共通設定（API、ステータス）
    │   └── sheets.js      # スプレッドシート設定（sheets/のみ）
    │   └── gmail.js       # Gmail設定（gmail/のみ）
    ├── main.js            # エントリーポイント
    ├── processors/
    │   └── unifiedProcessor.js  # 統合処理ロジック（sheets/）
    │   └── gmailProcessor.js    # Gmail処理ロジック（gmail/）
    └── services/
        ├── aiService.js         # OpenAI API連携
        ├── gmailService.js      # Gmail操作
        ├── sheetService.js      # スプレッドシート操作（sheets/のみ）
        └── managementService.js # 統合管理シート操作（sheets/のみ）
```

## 共通設定ファイル

### common.js（全プロジェクト共通）
```javascript
const COMMON_CONFIG = {
  // OpenAI API設定
  OPENAI: {
    MODEL: 'gpt-4o-mini',
    MAX_TOKENS: 500,
    TEMPERATURE: 0.7,
    API_URL: 'https://api.openai.com/v1/chat/completions'
  },
  
  // 共通ステータス
  STATUS: {
    PENDING: '',
    PROCESSING: '処理中', 
    COMPLETED: 'AI回答作成済',
    ERROR: 'エラー',
    TEST: 'テスト実行'
  },
  
  // エラーメッセージ
  ERROR_MESSAGES: {
    NO_API_KEY: 'APIキーが設定されていません',
    SHEET_NOT_FOUND: 'シートが見つかりません',
    API_ERROR: 'API Error'
  }
};
```

## 共通サービス

### aiService.js（AI回答生成）
```javascript
class AIService {
  static async generate[Type]Response(data) {
    // プロジェクト固有のプロンプト生成
    // OpenAI API呼び出し
    // レスポンス整形・返却
  }
}
```

### gmailService.js（Gmail操作）
```javascript
class GmailService {
  static createDraft(to, subject, body, labelName) {
    // Gmail下書き作成
    // ラベル付与
    // Draft ID返却
  }
}
```

### sheetService.js（スプレッドシート操作）
```javascript
class SheetService {
  static getSheet(sheetId, sheetName) { /* シート取得 */ }
  static checkAllConfigs() { /* シート設定確認 */ }
}
```

### managementService.js（統合管理シート操作 - V2.1新設）
```javascript
class ManagementService {
  static getUnprocessedRecords(sheetType) { /* 未処理レコード取得 */ }
  static createProcessingRecord(sheetType, timestamp) { /* 処理中記録作成 */ }
  static markAsCompleted(sheetType, timestamp, draftId) { /* 完了記録 */ }
  static getStatistics() { /* 統計情報取得 */ }
}
```

## 共通処理パターン

### 1. 初期化・設定確認
```javascript
function checkConfig() {
  // API Key確認
  // シート/Gmail接続確認  
  // 設定値出力
}
```

### 2. メイン処理フロー（V2.1統合管理シート方式）
```javascript
static process(sheetType) {
  // 1. 管理シートから未処理データ取得
  // 2. フォームシートから質問データ取得
  // 3. AI回答生成
  // 4. Gmail下書き作成
  // 5. 管理シートにステータス更新
  // 6. ログ出力
}
```

### 3. テスト実行
```javascript
static testSingleRow() {
  // メイン処理の1件限定版
  // 詳細ログ出力
}
```

### 4. トリガー管理
```javascript
function setupTrigger() {
  // 既存トリガー削除
  // 新規トリガー作成（1時間間隔）
}
```

## 共通エラーハンドリング

### エラー分類
1. **設定エラー**: API Key未設定、シート不存在
2. **API エラー**: OpenAI API、Gmail API制限
3. **データエラー**: 不正なデータ形式
4. **システムエラー**: GAS実行時間制限

### エラー記録方式（V2.1）
- **統合管理シート**: エラーステータス記録（フォームデータは変更しない）
- **Gmail系**: エラーラベル付与
- **共通**: console.error()でログ出力

## 共通セキュリティ対策

### API Key管理
- スクリプトプロパティで保存
- コードに直接記載禁止
- 定期的なローテーション推奨

### 権限管理
- 必要最小限の権限要求
- スプレッドシート共有設定
- Gmail読み取り/書き込み権限

### データ保護
- 個人情報の適切な取り扱い
- ログでの機密情報出力回避
- API使用量の監視

## 共通パフォーマンス最適化

### 実行時間制限対策
- 1回の実行件数制限（10-20件）
- バッチ処理によるAPI効率化
- タイムアウト設定

### API使用量最適化
- OpenAI API: トークン数制限
- Gmail API: レート制限遵守
- Sheets API: バッチ更新

### キャッシュ戦略
- 列インデックスのキャッシュ（WeekendEnt）
- 設定値のキャッシュ
- API レスポンスの適切な処理

## 共通デプロイ手順

1. **環境準備**: Clasp インストール・認証
2. **設定**: スクリプトプロパティ設定
3. **権限**: スプレッドシート共有、Gmail権限
4. **デプロイ**: `clasp push`
5. **テスト**: 単体テスト実行
6. **トリガー**: 定期実行設定

## 共通運用監視

### 監視項目
- API使用量（OpenAI, Gmail, Sheets）
- エラー発生率
- 処理成功率
- 実行時間

### ログ確認
- GAS実行ログ
- スプレッドシート処理状況
- Gmailラベル状況

### メンテナンス
- 定期的なログクリア
- API Key更新
- パフォーマンス最適化