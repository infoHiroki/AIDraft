# 04_Gmailラベル自動回答 - 技術仕様書

## プロジェクト概要
- **プロジェクト名**: 04_Gmailラベル自動回答
- **用途**: Gmail受信メール自動回答システム
- **GASプロジェクトID**: 設定済み

## Gmail仕様
### 処理対象
- **入力**: 特定ラベル付きGmailメール
- **出力**: Gmail下書き（返信）
- **管理**: ラベルベース処理状況管理

### ラベル構成
| ラベル名 | 用途 | 処理 |
|---|---|---|
| 処理対象ラベル | 自動回答対象メール | 設定で指定 |
| 処理済みラベル | 処理完了メール | 重複処理防止 |
| エラーラベル | 処理失敗メール | エラー管理 |

## 処理ロジック
### 処理条件
- 指定ラベルが付けられたメール
- 処理済みラベルが付いていない
- 未読または指定条件のメール

### 処理フロー
1. 対象ラベルのメール検索
2. 処理済みメールを除外
3. メール内容解析
4. AI回答生成
5. 返信下書き作成
6. 処理済みラベル付与

## AI回答生成
### 入力データ
```javascript
{
  from: "送信者メールアドレス",
  subject: "メール件名",
  body: "メール本文",
  date: "受信日時"
}
```

### 回答テンプレート
- メール内容に応じた自然な返信
- 丁寧で適切なトーン
- 具体的で有用な情報

## Gmail操作
### メール検索
```javascript
// ラベル条件でメール検索
const threads = GmailApp.search(`label:${targetLabel} -label:${processedLabel}`);
```

### 下書き作成
- 元メールへの返信形式
- 件名: Re: 元件名
- 適切な引用形式

### ラベル管理
- 処理開始: 処理中ラベル
- 正常完了: 処理済みラベル
- エラー時: エラーラベル

## ステータス管理
### ラベルベース管理
- メール単位での処理状況追跡
- 重複処理の完全防止
- エラー時の分類・管理

### 処理ログ
- Gmail内でのステータス確認
- 処理時刻の記録
- エラー内容の保存

## 実行関数
- `processLabeledEmails()`: 定期実行
- `testSingleEmail()`: テスト実行（1件）
- `setupTrigger()`: 定期実行トリガー設定
- `checkConfig()`: Gmail・API設定確認

## 設定項目
### スクリプトプロパティ
- `OPENAI_API_KEY`: OpenAI APIキー

### Gmail設定
```javascript
const GMAIL_CONFIG = {
  TARGET_LABEL: '処理対象ラベル名',
  PROCESSED_LABEL: '処理済みラベル名',
  ERROR_LABEL: 'エラーラベル名',
  MAX_EMAILS_PER_RUN: 10
};
```

## 制限事項
- Gmail API制限に注意
- 1実行あたりの処理件数制限
- ラベル操作の権限が必要

## ファイル構成
```
04_Gmailラベル自動回答/
├── src/config/
│   ├── common.js           # API設定、ステータス定数
│   └── gmail.js            # Gmail設定（ラベル名等）
├── src/processors/
│   └── labelProcessor.js   # メール処理ロジック
├── src/services/
│   ├── aiService.js        # OpenAI API連携
│   └── gmailService.js     # Gmail操作（検索・下書き・ラベル）
└── main.js                 # processLabeledEmails等
```

## 技術的特徴
1. **ラベルベース処理**: Gmailラベルで完全管理
2. **重複処理防止**: 処理済みラベルで確実に防止
3. **メール自動検出**: 新着メールを自動で処理
4. **返信形式**: 適切な返信フォーマット
5. **エラー処理**: ラベルによるエラー分類

## セキュリティ考慮
- Gmail読み取り権限の最小化
- 処理対象メールの限定
- API使用量の監視

## 運用上の注意
- ラベル名の事前設定が必要
- Gmail容量の定期的な確認
- 自動返信内容の品質チェック

## デプロイ手順
1. Gmail API有効化
2. ラベル作成・設定
3. スクリプトプロパティ設定
4. `clasp push`でデプロイ
5. テスト実行で動作確認
6. トリガー設定（適切な間隔）