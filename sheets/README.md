# AIDraft Sheets

スプレッドシート処理の統合プロジェクト。3つのシートから質問を取得し、AI回答を生成してGmail下書きを作成します。

## 概要

2025年1月のリファクタリングにより、旧01〜03番の3つの独立プロジェクトが1つの統合システムに統合されました。
1つのスプレッドシート内の3つのシートを処理し、各シートの異なる列構成に対応しています。

### V2.1 統合管理シート方式（2025年1月実装）
フォーム項目の急激な増加に対応するため、統合管理シート「AI処理管理」による処理状況管理を実装。
フォームデータとシステム管理データを完全分離し、項目数無制限対応を実現。

## スプレッドシート構成

### スプレッドシートID
`1PPwXbBGdSLIC8yeQY33dNDlEqjdJ4X-PibaDPiWU6Io`

### 各シートの詳細

#### 1. WeekenDentシート
- **質問列**: F列（ご質問）
- **旧ステータス列**: J列（事務局対応 - V2.1以降は参照不要）
- **ラベル**: `AI自動回答_WeekendEnt`
- **列構成**:
  - A列: タイムスタンプ
  - B列: メールアドレス
  - C列: 歯科（クリニック名）
  - D列: 先生（お名前）
  - E列: セミナーのご感想
  - F列: ご質問
  - J列: 事務局対応（旧システム - 新システムでは使用しない）

#### 2. その他セミナーシート
- **質問列**: F列（質問）
- **旧ステータス列**: G列（事務局対応 - V2.1以降は参照不要）
- **ラベル**: `AI自動回答_その他`
- **列構成**:
  - A列: タイムスタンプ
  - B列: メールアドレス
  - C列: 名前
  - D列: 院名
  - E列: 感想
  - F列: 質問
  - G列: 事務局対応（旧システム - 新システムでは使用しない）

#### 3. お問い合わせシート  
- **質問列**: F列（質問）
- **旧ステータス列**: H列（事務局対応 - V2.1以降は参照不要）
- **ラベル**: `AI自動回答_お問い合わせ`
- **列構成**:
  - A列: タイムスタンプ
  - B列: メールアドレス
  - C列: 院名（クリニック名）
  - D列: 名前
  - E列: 概要
  - F列: 質問
  - G列: （未使用）
  - H列: 事務局対応（旧システム - 新システムでは使用しない）

#### 4. AI処理管理シート（V2.1新設）
- **シート名**: `AI処理管理`
- **機能**: 全処理状況の一元管理
- **列構成**:
  - A列: 種別（WeekenDent/その他セミナー/お問い合わせ）
  - B列: タイムスタンプ（元データとの紐付けキー）
  - C列: 処理ステータス（完了/エラー/処理中/テスト実行）

## 処理フロー（V2.1: 管理シートベース）

1. **データ取得**: 質問列（F列）に値があり、管理シートに未登録の行を取得
2. **AI回答生成**: OpenAI GPT-4o-miniを使用して日本語の回答を生成
3. **Gmail下書き作成**: 生成された回答をGmail下書きとして作成
4. **ステータス更新**: 管理シートに処理ステータスを記録

## 安全性

- **データ上書きリスク**: なし（フォームシートは読み取り専用）
- **更新対象**: 管理シートのみ（フォームデータは一切変更しない）
- **フォーム拡張対応**: 項目数無制限（管理シート方式により完全対応）

## 主要な関数

### メイン処理関数
- `processWeekendDent()` - WeekendDentシートの未処理質問を最大20件まで処理
- `processOtherSeminar()` - その他セミナーシートの未処理質問を最大20件まで処理
- `processInquiry()` - お問い合わせシートの未処理問い合わせを最大20件まで処理

### テスト関数
- `testWeekendDent()` - WeekendDentシートの1件のみテスト処理
- `testOtherSeminar()` - その他セミナーシートの1件のみテスト処理
- `testInquiry()` - お問い合わせシートの1件のみテスト処理

### 管理関数
- `checkConfig()` - APIキー設定、全シートの接続状況、管理シート統計確認
- `showStatistics()` - 処理統計情報の詳細表示（日常監視用）
- `migrateExistingData()` - 既存データの管理シートへの移行（初回のみ実行）

### トリガー管理
- `setupTriggers()` - 全シート用の1時間ごとの自動実行トリガー設定
- `deleteTriggers()` - 全トリガー削除

## 使い方

### 初期設定
1. GASプロジェクトのスクリプトプロパティに`OPENAI_API_KEY`を設定
2. スプレッドシートを`globaldental.seminar@gmail.com`に共有（編集権限）
3. `checkConfig()`を実行して設定を確認

### テスト実行
```javascript
// 各シートの1件のみテスト
testWeekendDent();
testOtherSeminar();
testInquiry();
```

### 本番運用
```javascript
// 自動実行トリガーを設定
setupTriggers();

// 手動実行も可能
processWeekendDent();
processOtherSeminar();
processInquiry();
```

## アーキテクチャ

- **UnifiedProcessor**: 統一処理ロジックで各シートの設定を切り替え
- **設定駆動**: `config/sheets.js`に各シートの設定を集約
- **サービス分離**: AI、Gmail、Sheetの各サービスを独立モジュール化
- **エラーハンドリング**: 各レイヤーで適切なエラー処理を実装

## 注意事項

- スプレッドシートの列構成が変更された場合は、`config/sheets.js`の更新が必要
- AI回答はGmail下書きとして保存され、スプレッドシートにはステータスのみ記録
- 1回の実行で各シート最大20件まで処理（GASの6分制限対策）