# CLAUDE.md

このファイルは、このリポジトリのコードを操作する際のClaude Code (claude.ai/code) へのガイダンスを提供します。

## プロジェクト概要

AIDraftは、Google Apps Script（GAS）で構築された日本語対応のAI自動メール返信システムです。OpenAIのGPT-4o-miniモデルを使用して、歯科セミナーのお問い合わせに対するAI応答を自動生成し、Gmailの下書きを作成します。

2025年のリファクタリングにより、旧来の4つの独立プロジェクトから2つの統合プロジェクトに再編成されました。

## アーキテクチャ

現在のプロジェクト構成：
- `sheets/` - 統合スプレッドシート処理システム（3つのシートを1つのシステムで処理）
- `gmail/` - Gmail未読メール処理（旧04_Gmail未読処理）
- `archive/` - 旧プロジェクト（01〜04）のアーカイブ

各プロジェクトは同一のアーキテクチャに従います：

### 標準ディレクトリ構造
```
[プロジェクト名]/
├── README.md               # プロジェクト固有ドキュメント
├── .clasp.json            # GASデプロイ設定
└── src/
    ├── appsscript.json    # GAS設定ファイル
    ├── config/
    │   ├── common.js      # 共通設定（API、ステータス）
    │   └── sheets.js      # スプレッドシート設定（sheets/のみ）
    │   └── gmail.js       # Gmail設定（gmail/のみ）
    ├── main.js            # エントリーポイント
    ├── processors/
    │   └── unifiedProcessor.js  # 統合処理ロジック（sheets/）
    │   └── gmailProcessor.js    # Gmail処理ロジック（gmail/）
    └── services/
        ├── aiService.js   # OpenAI API連携
        ├── gmailService.js # Gmail操作
        └── sheetService.js # スプレッドシート操作（sheets/のみ）
```

## 開発コマンド

### デプロイ
```bash
# Google Apps Scriptにデプロイ（各プロジェクトディレクトリから実行）
clasp push
clasp deploy
```

### テスト
```bash
# GASエディタで以下の関数を実行

# sheets/プロジェクト
checkConfig()           # 設定・接続確認
testWeekendDent()       # WeekenDent 1件テスト
testOtherSeminar()      # その他セミナー 1件テスト
testInquiry()           # お問い合わせ 1件テスト

# gmail/プロジェクト
checkConfig()           # 設定・Gmail権限確認
testSingleEmail()       # 1件のみ処理テスト
```

### 設定管理
- 各プロジェクトにはデプロイ設定用の`.clasp.json`があります
- `appsscript.json`はV8ランタイムとAmerica/New_Yorkタイムゾーンを設定
- 共通設定は`src/config/common.js`
- プロジェクト固有の設定は`src/config/sheets.js`または`src/config/gmail.js`

## 詳細設定情報

### APIキー設定

#### OpenAI API
- **設定場所**: GAS → プロジェクト設定 → スクリプトプロパティ
- **キー名**: `OPENAI_API_KEY`
- **値**: OpenAI APIキー（sk-proj-...）
- **モデル**: `gpt-4o-mini`

### スプレッドシート設定（sheets/プロジェクト）

#### スプレッドシート情報
- **ID**: `1PPwXbBGdSLIC8yeQY33dNDlEqjdJ4X-PibaDPiWU6Io`
- **共有先**: `globaldental.seminar@gmail.com`
- **権限**: 編集者
- **必要性**: スプレッドシートへのアクセスに必須

#### 各シートの構成

##### 1. WeekenDentシート
- **シート名**: `WeekenDent`
- **質問列**: F列（ご質問）
- **ラベル**: `AI自動回答_WeekendEnt`
- **データ構造**:
  - A列: タイムスタンプ
  - B列: メールアドレス
  - C列: 歯科（クリニック名）
  - D列: 先生（お名前）
  - E列: セミナーのご感想
  - F列: ご質問

##### 2. その他セミナーシート
- **シート名**: `その他セミナー`
- **質問列**: F列（質問）
- **ラベル**: `AI自動回答_その他`
- **データ構造**:
  - A列: タイムスタンプ
  - B列: メールアドレス
  - C列: 名前
  - D列: 院名
  - E列: 感想
  - F列: 質問

##### 3. お問い合わせシート
- **シート名**: `お問い合わせ`
- **質問列**: F列（質問）
- **ラベル**: `AI自動回答_お問い合わせ`
- **データ構造**:
  - A列: タイムスタンプ
  - B列: メールアドレス
  - C列: 院名（クリニック名）
  - D列: 名前
  - E列: 概要
  - F列: 質問

#### 統合管理シート仕様（V2 - 2025年1月実装）
- **管理方式**: 統合管理シート「AI処理管理」で処理状況を一元管理
- **処理判定**: 質問列に値があり、かつ管理シートに未登録の行が処理対象
- **データ安全性**: フォームデータとシステム管理データが完全分離
- **拡張対応**: フォーム項目数に制限なし（根本的解決）
- **移行完了**: 2025年1月に374件の既存データを完全移行、本格運用開始

#### 統合管理シート構造
```
AI処理管理シート:
A列: 種別（WeekenDent/その他セミナー/お問い合わせ）
B列: タイムスタンプ（元データとの紐付けキー）
C列: 処理ステータス（完了/エラー/処理中/テスト実行）
```

#### 処理フロー（V2 - 管理シートベース）
1. 各フォームシートから質問データを検索（F列）
2. 管理シートで未処理判定（タイムスタンプベース）
3. AI処理実行とGmail下書き作成
4. 管理シートに処理ステータス記録
5. フォームシートは読み取り専用として保持

#### V2.1システムの特徴
- **完全独立動作**: フォームシートの列構成に依存しない
- **データ分離**: フォームデータと管理データを完全分離
- **拡張性**: フォーム項目の追加・変更に影響を受けない


### システム設定

#### 処理制限
- **1回の最大処理件数**: 20件
- **自動実行間隔**: 1時間（setupTrigger()使用時）
- **タイムアウト**: Google Apps Script 6分制限

#### Gmail設定
- **送信者**: 実行ユーザーのGmailアカウント
- **下書きラベル**: 自動作成・付与
- **自動送信**: なし（下書きのみ）
- **件名**: "Re: セミナーについてのご質問"

#### 統合出力形式
```
2025/06/09 14:25
Draft ID: abc123def456
────────────────
[AI生成回答内容]
```

### プロジェクト別関数（V2: 統合管理シートベース）

#### sheets/プロジェクト（統合スプレッドシート処理）

##### 個別シート処理関数（管理シートベース）
- **WeekendDent処理**: `processWeekendDent()` - 管理シートベースで未処理質問を最大20件まで自動処理
- **その他セミナー処理**: `processOtherSeminar()` - 管理シートベースで未処理質問を最大20件まで自動処理
- **お問い合わせ処理**: `processInquiry()` - 管理シートベースで未処理問い合わせを最大20件まで自動処理

##### テスト関数（管理シートベース）
- **WeekendDentテスト**: `testWeekendDent()` - 1件のみ処理して管理シートに「テスト実行」として記録
- **その他セミナーテスト**: `testOtherSeminar()` - 1件のみ処理して管理シートに「テスト実行」として記録
- **お問い合わせテスト**: `testInquiry()` - 1件のみ処理して管理シートに「テスト実行」として記録

##### 共通管理関数（V2 - 管理シートベース）
- **設定確認**: `checkConfig()` - APIキー設定、全シート接続状況、管理シート統計の確認
- **統計表示**: `showStatistics()` - 処理統計情報の詳細表示（日常監視用）
- **データ移行**: `migrateExistingData()` - 既存の処理済みデータを管理シートに移行（移行時のみ使用）
- **トリガー設定**: `setupTriggers()` - 全シート用の1時間ごと自動実行トリガーを作成
- **トリガー削除**: `deleteTriggers()` - 全自動実行トリガーを削除（システム停止用）
- **統合処理**: `processAllSheets()` - 全シートの手動一括処理（通常は使用しない）

##### 運用推奨関数
- **日常監視**: `showStatistics()` - 定期的な処理状況確認
- **障害調査**: `checkConfig()` - システム異常時の診断
- **緊急停止**: `deleteTriggers()` - 自動処理の即座停止

#### gmail/プロジェクト（Gmail未読処理）
- **メイン処理**: `processLabeledEmails()` - AI回答要求ラベル付きメールを最大10件まで自動処理
- **テスト実行**: `testSingleEmail()` - 1件のみ処理（ラベル変更なし）
- **設定確認**: `checkConfig()` - APIキー設定、Gmail権限の確認
- **トリガー設定**: `setupTrigger()` - 1時間ごとの定期実行トリガーを作成
- **トリガー削除**: `deleteTriggers()` - processLabeledEmails用のトリガーを全削除

### Gmail設定（gmail/プロジェクト専用）

#### ラベル設定
- **処理対象ラベル**: `AI回答要求` - 手動でメールに付けるラベル
- **処理済みラベル**: `AI自動回答_Gmail` - 処理完了後に自動変更

#### 処理制限
- **1回の最大処理件数**: 10件
- **自動実行間隔**: 1時間（setupTrigger()使用時）
- **対象メール**: ラベル付きメールのみ

#### Gmail動作
- **検索対象**: `AI回答要求`ラベル付きメール
- **除外条件**: `AI自動回答_Gmail`ラベル付きメール
- **処理後**: ラベル変更 + 既読化 + 返信下書き作成

## 主要技術詳細

### AIサービス統合
- OpenAI GPT-4o-miniを使用（最大500トークン、温度0.7）
- コンテキスト対応プロンプトを使った日本語応答テンプレート
- API障害時のフォールバック応答を含むエラーハンドリング

### Gmail処理
- 適切なラベル（「AI Draft」、「AI Error」）付きの下書き作成
- ステータス追跡による重複防止処理
- `gmailService.js`でのカスタムGmail API統合

### Googleスプレッドシート統合
- 設定可能なマッピングによる列ベースのデータ抽出
- 重複処理防止のためのステータス追跡
- 個別エラー分離によるバッチ処理

### トリガーシステム
- 本番処理用の毎時自動トリガー
- 単一項目テスト用の手動トリガー関数
- 各プロジェクトでのトリガー管理機能（設定/削除）

### テスト戦略

#### sheets/プロジェクト
実際のスプレッドシートデータを使用した統合テスト：
- `checkConfig()` - 全シートの設定・接続確認
- `testWeekendDent()` - WeekenDentシートの1件実処理
- `testOtherSeminar()` - その他セミナーシートの1件実処理
- `testInquiry()` - お問い合わせシートの1件実処理
- テスト実行時は「テスト実行」ステータスを記録

#### gmail/プロジェクト
実際のGmailを使用した統合テスト：
- `checkConfig()` - Gmail権限・ラベル確認
- `testSingleEmail()` - 1件のみ処理（ラベル変更なし）
- 単体テスト・統合テストも実装済み

### 返信テンプレート

```
${info.clinicName}
${info.doctorName}先生

GDX事務局 中村です。
お世話になります。

セミナーに参加していただき、ありがとうございました。
また、アンケートのご返答、ありがとうございます｡

先生から頂きました質問は以下です。

━━━━━━━━━━━━━━━━
[ここに質問内容を記載]
━━━━━━━━━━━━━━━━

以下、回答です。

━━━━━━━━━━━━━━━━
[ここに適切な回答を記載してください]
━━━━━━━━━━━━━━━━

何かご質問があれば、お気軽に聞いて下さい。
どうぞよろしくお願いします。

GDX事務局 中村
seminar@globaldentalx.com
03-4510-4792
```

## 一般的な開発パターン

### エラーハンドリング
すべてのサービスは一貫したエラーハンドリングを実装：
- 外部API呼び出し周りのtry-catchブロック
- データソースでのステータス追跡
- デバッグ用の詳細ログ
- 個別項目障害に対する優雅な劣化

### ステータス管理
標準ステータスフロー：`未処理` → `処理中` → `完了` または `エラー`

### サービス層パターン
各サービス（AI、Gmail、Sheets）は以下で分離：
- 外部依存関係のクリーンインターフェース
- 設定の注入
- エラー境界ハンドリング
- ログ統合

## 技術アーキテクチャ詳細

### 共通技術スタック

#### プラットフォーム
- **実行環境**: Google Apps Script (GAS)
- **言語**: JavaScript (ES6+)
- **デプロイ**: Google Clasp
- **バージョン管理**: Git

#### 外部API
- **AI**: OpenAI GPT-4o-mini
- **メール**: Gmail API
- **スプレッドシート**: Google Sheets API

#### 認証・権限
- **Gmail**: OAuth 2.0
- **Sheets**: OAuth 2.0
- **OpenAI**: API Key認証

### 共通設定ファイル

#### common.js（全プロジェクト共通）
```javascript
const COMMON_CONFIG = {
  // OpenAI API設定
  OPENAI: {
    MODEL: 'gpt-4o-mini',
    MAX_TOKENS: 500,
    TEMPERATURE: 0.7,
    API_URL: 'https://api.openai.com/v1/chat/completions'
  },
  
  // 共通ステータス
  STATUS: {
    PENDING: '',
    PROCESSING: '処理中', 
    COMPLETED: 'AI回答作成済',
    ERROR: 'エラー',
    TEST: 'テスト実行'
  },
  
  // エラーメッセージ
  ERROR_MESSAGES: {
    NO_API_KEY: 'APIキーが設定されていません',
    SHEET_NOT_FOUND: 'シートが見つかりません',
    API_ERROR: 'API Error'
  }
};
```

### 共通サービス

#### aiService.js（AI回答生成）
```javascript
class AIService {
  static async generate[Type]Response(data) {
    // プロジェクト固有のプロンプト生成
    // OpenAI API呼び出し
    // レスポンス整形・返却
  }
}
```

#### gmailService.js（Gmail操作）
```javascript
class GmailService {
  static createDraft(to, subject, body, labelName) {
    // Gmail下書き作成
    // ラベル付与
    // Draft ID返却
  }
}
```

#### sheetService.js（スプレッドシート操作）
```javascript
class SheetService {
  static getSheet(sheetId, sheetName) { /* シート取得 */ }
  static getColumnIndexByHeader(sheet, headerName, options) { /* 動的列検索 */ }
  static updateResponse(sheet, rowIndex, ...) { /* 結果更新 */ }
}
```

### 共通処理パターン

#### 1. 初期化・設定確認
```javascript
function checkConfig() {
  // API Key確認
  // シート/Gmail接続確認  
  // 設定値出力
}
```

#### 2. メイン処理フロー
```javascript
static process() {
  // 1. データ源からの未処理データ取得
  // 2. 処理条件判定
  // 3. AI回答生成
  // 4. Gmail下書き作成
  // 5. ステータス更新
  // 6. ログ出力
}
```

#### 3. テスト実行
```javascript
static testSingleRow() {
  // メイン処理の1件限定版
  // 詳細ログ出力
}
```

#### 4. トリガー管理
```javascript
function setupTrigger() {
  // 既存トリガー削除
  // 新規トリガー作成（1時間間隔）
}
```

### 共通エラーハンドリング

#### エラー分類
1. **設定エラー**: API Key未設定、シート不存在
2. **API エラー**: OpenAI API、Gmail API制限
3. **データエラー**: 不正なデータ形式
4. **システムエラー**: GAS実行時間制限

#### エラー記録方式
- **スプレッドシート系**: 管理シートにエラーステータス記録
- **Gmail系**: エラーラベル付与
- **共通**: console.error()でログ出力

### 共通セキュリティ対策

#### API Key管理
- スクリプトプロパティで保存
- コードに直接記載禁止
- 定期的なローテーション推奨

#### 権限管理
- 必要最小限の権限要求
- スプレッドシート共有設定
- Gmail読み取り/書き込み権限

#### データ保護
- 個人情報の適切な取り扱い
- ログでの機密情報出力回避
- API使用量の監視

### 共通パフォーマンス最適化

#### 実行時間制限対策
- 1回の実行件数制限（10-20件）
- バッチ処理によるAPI効率化
- タイムアウト設定

#### API使用量最適化
- OpenAI API: トークン数制限
- Gmail API: レート制限遵守
- Sheets API: バッチ更新

#### キャッシュ戦略
- 列インデックスのキャッシュ（WeekendEnt）
- 設定値のキャッシュ
- API レスポンスの適切な処理

## プロジェクト固有の注意事項

### sheets/プロジェクト（統合スプレッドシート処理）
- 1つのスプレッドシートに3つのシートを統合管理
- 各シートで異なる列構成に対応（固定列マッピング）
- V2.1管理シート方式で処理状況を管理
- `config/sheets.js`で各シートの設定を一元管理

### gmail/プロジェクト（Gmail未読処理）
- 指定されたGmailラベルからの未読メールを処理
- 包括的なテストスイート（単体・統合テスト）を含む
- `config/gmail.js`でのGmail固有設定を使用

## 重要な制約

- Google Apps Scriptの6分実行時間制限
- V8ランタイム環境（ES6+サポート）
- npm/node_modulesなし - 純粋なGAS環境
- 一貫したスケジュール設定のためAmerica/New_Yorkタイムゾーンに設定

## 移行履歴

### v2.0 統合リファクタリング（2025年1月実施）

#### 主な変更点
1. **プロジェクト統合**
   - 01〜03番の独立プロジェクトを `sheets/` に統合
   - 04番のプロジェクトを `gmail/` にリネーム
   - 旧プロジェクトは `archive/` に保存

2. **アーキテクチャ改善**
   - 動的列検索を廃止し、固定列マッピングに移行
   - スプレッドシートを1つに統合（3シート構成）
   - 設定駆動型アーキテクチャの採用
   - 統一プロセッサー（UnifiedProcessor）の実装

3. **安全性向上**
   - データ上書きリスクの完全排除
   - ステータス列のみの更新に限定
   - エラーハンドリングの強化

### v2.1 統合管理シート方式（2025年1月実施）

#### 背景・課題
- フォーム項目の急激な増加（WeekenDentシートが84列まで拡張）
- 事務局対応列の位置競合問題が現実化
- Z列固定方式の限界露呈

#### 実装内容
1. **統合管理シート導入**
   - 「AI処理管理」シートで全処理状況を一元管理
   - フォームデータとシステム管理データの完全分離

2. **処理ロジックの刷新**
   - 管理シートベースの未処理判定
   - タイムスタンプによるデータ紐付け
   - 事務局対応列への依存完全排除

3. **データ移行**
   - 既存374件の処理済みデータを統合管理シートに完全移行
   - 重複処理防止の実現

4. **運用改善**
   - フォーム項目数無制限対応
   - 処理状況の完全可視化
   - 統計情報とエラー分析機能の実装

### 旧プロジェクト構成
- `01_お問い合わせ/` - 独立したお問い合わせ処理
- `02_その他セミナー/` - 独立したその他セミナー処理
- `03_WeekendEnt/` - 独立したWeekendDent処理
- `04_Gmail未読処理/` - Gmail処理（現gmail/）