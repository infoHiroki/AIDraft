# V2.1 統合管理シート仕様

## 概要

AIDraft V2.1で実装された統合管理シート方式は、Google Forms項目数の急激な増加（WeekenDentシートが84列まで拡張）に対応するため、フォームデータとシステム管理データを完全分離したアーキテクチャです。

## 背景・課題

### 従来の課題
- **フォーム拡張問題**: WeekendDentシートが84列まで拡張、固定列アプローチの限界
- **データ上書きリスク**: フォームシートへの直接書き込みによる危険性
- **保守性の低下**: 列位置の変更に対する脆弱性

### V2.1での解決策
- **統合管理シート**: 処理状況を専用シートで一元管理
- **データ分離**: フォームデータ（読み取り専用）とシステムデータ（管理シート）の完全分離
- **無制限拡張対応**: フォーム項目数に制限なし

## アーキテクチャ

### データフロー
```
Googleフォーム → フォームシート（読み取り専用）
                      ↓
               統合管理シート（処理状況管理）
                      ↓
                Gmail下書き作成
```

### 処理判定ロジック
1. **フォームシート**から質問列（F列）に値がある行を検索
2. **管理シート**で該当タイムスタンプの処理状況を確認
3. **未処理の場合のみ**AI処理を実行
4. **管理シート**に処理結果を記録

## 統合管理シート仕様

### シート名
`AI処理管理`

### 列構成
| 列 | 項目名 | 説明 |
|---|---|---|
| A | 種別 | WeekenDent/その他セミナー/お問い合わせ |
| B | タイムスタンプ | フォームデータとの紐付けキー |
| C | 処理ステータス | 完了/エラー/処理中/テスト実行 |

### 自動作成機能
- シートが存在しない場合は自動作成
- ヘッダー行を自動設定
- 太字スタイルを適用

## 処理ステータス

### ステータス一覧
- **空文字**: 未処理（管理シートに未登録）
- **処理中**: AI処理実行中
- **完了**: AI処理完了、Gmail下書き作成済み
- **エラー**: 処理中にエラーが発生
- **テスト実行**: テスト関数による処理

### ステータス遷移
```
未処理 → 処理中 → 完了
             ↓
           エラー
```

## 主要サービス

### ManagementService

#### getUnprocessedRecords(sheetType)
```javascript
/**
 * 指定シートタイプの未処理レコードを取得
 * @param {string} sheetType - 'WEEKEND', 'OTHER', 'INQUIRY'
 * @returns {Array} 未処理レコード配列
 */
```

#### createProcessingRecord(sheetType, timestamp)
```javascript
/**
 * 処理中レコードを作成
 * @param {string} sheetType - シートタイプ
 * @param {Date} timestamp - タイムスタンプ
 */
```

#### markAsCompleted(sheetType, timestamp, draftId)
```javascript
/**
 * 処理完了として記録
 * @param {string} sheetType - シートタイプ
 * @param {Date} timestamp - タイムスタンプ
 * @param {string} draftId - Gmail下書きID（オプション）
 */
```

#### getStatistics()
```javascript
/**
 * 処理統計情報を取得
 * @returns {Object} 統計情報オブジェクト
 */
```

## 設定管理

### sheets.js拡張
```javascript
const SHEET_CONFIG = {
  // 統合管理シート名
  MANAGEMENT_SHEET_NAME: 'AI処理管理',
  
  // 各シートの実際のステータス列位置
  SHEETS: {
    WEEKEND: { statusColumn: 'J', ... },
    OTHER: { statusColumn: 'G', ... },
    INQUIRY: { statusColumn: 'H', ... }
  }
};
```

### getManagementSheet()関数
- 統合管理シートの取得・自動作成
- 初回実行時のヘッダー設定
- エラーハンドリング

## データ移行

### 既存データ移行（実装済み）
- **対象**: 374件の処理済みデータ
- **実施日**: 2025年1月
- **移行内容**: 各シートの事務局対応列（J/G/H列）のデータを管理シートに移行
- **ステータス**: 全件「完了」として記録

### migrateExistingData()関数
```javascript
/**
 * 既存の処理済みデータを統合管理シートに移行
 * 各シートの事務局対応列に値がある行を「完了」として記録
 */
```

## 統計・監視機能

### showStatistics()関数
```javascript
// 出力例
総処理件数: 374件
完了: 374件
処理中: 0件
エラー: 0件

--- シート別統計 ---
WEEKEND: 計158件 (完了:158, 処理中:0, エラー:0)
OTHER: 計124件 (完了:124, 処理中:0, エラー:0)
INQUIRY: 計92件 (完了:92, 処理中:0, エラー:0)
```

### 日常監視
- `showStatistics()`による処理状況確認
- 管理シートでの直接確認
- エラー件数の監視

## 安全性・信頼性

### データ保護
- **フォームシート**: 完全読み取り専用
- **管理シート**: システムデータのみ
- **上書きリスク**: 完全排除

### 拡張性
- **フォーム項目数**: 無制限対応
- **新規フォーム追加**: 設定追加のみで対応
- **バックワード互換性**: 旧ステータス列との並行運用可能

### エラー耐性
- **部分処理失敗**: 他の処理に影響なし
- **重複処理防止**: タイムスタンプベースの厳密チェック
- **ロールバック**: 管理シートでのステータス管理により容易

## 運用への影響

### 処理方式の変更
- **旧**: フォームシートのステータス列確認
- **新**: 管理シートでの処理状況確認

### 既存システムとの関係
- **旧ステータス列**: 残存するが参照不要
- **削除**: クライアント確認後に実施予定
- **下位互換性**: 完全維持

### 関数の変更
- **setupTrigger()** → **setupTriggers()**: 3シート統合対応
- **testSingle関数**: 新システム対応済み
- **新関数**: showStatistics(), migrateExistingData()

## 今後の拡張計画

### 可能な機能拡張
1. **処理履歴**: タイムスタンプ、処理時間の記録
2. **エラー詳細**: エラー内容の詳細記録
3. **パフォーマンス**: 処理時間の統計
4. **アラート**: エラー率閾値での通知

### 他システムへの適用
- Gmail処理システムへの管理シート方式適用
- 他のGASプロジェクトでの採用

## まとめ

V2.1統合管理シート方式により：
- **フォーム項目数無制限**の柔軟性を実現
- **データ安全性**を大幅に向上
- **運用効率**を統合により改善
- **将来の拡張性**を確保

この方式により、Googleフォームの急激な拡張にも対応でき、長期間の安定運用が可能となりました。